<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>说者无意</title>
  

  <!-- Included CSS Files (Uncompressed) -->
  <!--
  <link rel="stylesheet" href="/themes/foundation/stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="/themes/foundation/stylesheets/foundation.min.css">
  <link rel="stylesheet" href="/themes/foundation/stylesheets/app.css">

  <script src="/themes/foundation/javascripts/modernizr.foundation.js"></script>
</head>
<body>

  <!-- Nav Bar -->
  <div class="row">
    <div class="twelve columns">
      <h2>说者无意<small>代码如诗，生活如画</small></h2>
      <ul class="nav-bar">
        <li><a href="#">Link 1</a></li>
        <li><a href="#">Link 2</a></li>
        <li><a href="#">Link 3</a></li>
        <li><a href="#">Link 4</a></li>
      </ul>
    </div>
  </div>

  <!-- End Nav -->


  <!-- Main Page Content and Sidebar -->

  <div class="row">

    <!-- Main Blog Content -->
    <div class="eight columns" role="content">

      <article>

        <h1></h1>
        <h6>Written by <a href="#">John Smith</a> on August 12, 2012.</h6>

        <div class="row">
          <div class="six columns">
            学习了<code>AbstractQueuedSynchronizer</code> 之后(<code>Condition</code>没有在上文做笔记，当应该不难理解)，接下来笔者就尝试着分析在<code>JUC</code>包中的各个同步器，其语义是如何实现的。



<h2>ReentrantLock</h2>

内部类<code>Sync</code>继承了<code>AbstractQueuedSynchronizer</code>。<code>state</code>表示锁被重入的次数。因为其是独占锁，所以只实现了<code>tryRelease</code>，<code>isHeldExclusively</code>方法，而<code>tryAcquire</code>则交由子类基于公平和非公平的策略来实现。



公平的<code>ReentrantLock</code>会在每次<code>tryAcquire</code>的时候，都老老实实让排在队列前面的线程优先拿锁。而非公平锁则是发现<code>state</code>为0后，就马上去尝试设置<code>state</code>，如果不能成功，才进入<code>AQS</code>内部的队列老老实实的排队。



<h2>ReentrantReadWriteLock</h2>

此类最为复杂。内部类<code>Sync</code>继承了<code>AbstractQueuedSynchronizer</code>，同时内部类<code>ReadLock</code>和<code>WriteLock</code>内部共享了<code>Sync</code>，<code>state</code>这个<code>int</code>被划分成两部分，高位16个bit表示共享读锁，低位16个bit表示独占写锁。



大概的工作方式是：读锁使用<code>shared模式</code>，复写<code>tryAcquireShared</code>和<code>tryReleaseShared</code>；写锁使用独占锁，复写<code>tryAcquire</code>和<code>tryRelease</code>。当线程要求锁住写锁的时候，内部会检查<code>state</code>是否为0；如果不为0，则检查此时是写状态还是读状态；如果是写状态，则检查持有写锁的是否是自己；如果是的话，则进行锁重入。锁住读锁也是这个道理，只不过是使用的<code>shared</code>的锁模式而已。



<h2>Semaphore</h2>

使用<code>state</code>表示信号量。可以想象，使用是的<code>shared</code>模式。在<code>acquire</code>的时候，会去比较<code>state</code>来判断是否可以成功。



需要注意的是此类如果使用不当，则可能会有线程被挂住的问题，测试代码可以参见这里：<a href="https://gist.github.com/3879133">https://gist.github.com/3879133</a>。



<h2>CountDownLatch</h2>

与<code>Semaphore</code>一样，都是非常简单的使用了<code>state</code>。



<h2>CyclicBarrier</h2>

内部使用的是<code>ReentrantLock</code>，利用了<code>Condition</code>来唤醒栅栏前的线程。



<h2>FutureTask</h2>

使用<code>state</code>来表示任务的执行状态。代码也相对比较简单。值得注意的是，<code>FutureTask</code>对于任务执行抛出的异常，是会捕捉住的（在get的时候才会给抛给你），如果在编写任务时候没有<code>catch(Exception)</code>，而导致有异常漏过业务代码，则很有可能产生不可预知的问题。比如，在使用 <code>ScheduledExecutorService</code>分发定时任务之后，而又不关心返回结果的时候，就可能会出现问题。所以一般对自己的线程，也应该处理自己线程的异常，这也是最佳实践的原则。



          </div>
          <div class="six columns">
            <img src="http://placehold.it/400x240&text=[img]" />
          </div>
        </div>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

      </article>

      <hr />

      <article>

        <h3><a href="#">Blog Post Title</a></h3>
        <h6>Written by <a href="#">John Smith</a> on August 12, 2012.</h6>

        <div class="row">
          <div class="six columns">
            <p>Bacon ipsum dolor sit amet nulla ham qui sint exercitation eiusmod commodo, chuck duis velit. Aute in reprehenderit, dolore aliqua non est magna in labore pig pork biltong. Eiusmod swine spare ribs reprehenderit culpa.</p>
            <p>Boudin aliqua adipisicing rump corned beef. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>
          </div>
          <div class="six columns">
            <img src="http://placehold.it/400x240&text=[img]" />
          </div>
        </div>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

      </article>

    </div>

    <!-- End Main Content -->


    <!-- Sidebar -->

    <aside class="four columns">

      <h5>Categories</h5>
      <ul class="side-nav">
        <li><a href="#">News</a></li>
        <li><a href="#">Code</a></li>
        <li><a href="#">Design</a></li>
        <li><a href="#">Fun</a></li>
        <li><a href="#">Weasels</a></li>
      </ul>

      <div class="panel">
        <h5>Featured</h5>
        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow.</p>
        <a href="#">Read More &rarr;</a>
      </div>

    </aside>

    <!-- End Sidebar -->
  </div>

  <!-- End Main Content and Sidebar -->


  <!-- Footer -->

  <footer class="row">
    <div class="twelve columns">
      <hr />
      <div class="row">
        <div class="six columns">
          <p>&copy; Copyright no one at all. Go to town.</p>
        </div>
        <div class="six columns">
          <ul class="link-list right">
            <li><a href="#">Link 1</a></li>
            <li><a href="#">Link 2</a></li>
            <li><a href="#">Link 3</a></li>
            <li><a href="#">Link 4</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- End Footer -->

  <!-- Included JS Files (Compressed) -->
  <script src="/themes/foundation/javascripts/jquery.js"></script>
  <script src="/themes/foundation/javascripts/foundation.min.js"></script>
  
  <!-- Initialize JS Plugins -->
  <script src="/themes/foundation/javascripts/app.js"></script>
  
</body>
</html>
