
<!DOCTYPE html>

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />
  <title>Java并发同步器AQS(AbstractQueuedSynchronizer)学习笔记(1)</title>
  
  

  <link rel="alternate" type="application/rss+xml" title="说者无意 &raquo; Feed" href="/atom.xml" />
  <link rel="stylesheet" href="/assets/themes/foundation/stylesheets/foundation.min.css">
  <link rel="stylesheet" href="/assets/themes/foundation/stylesheets/app.css">
  <link rel="stylesheet" href="/assets/themes/foundation/hl/styles/tomorrow-night-bright.css">
  <script src="/assets/themes/foundation/javascripts/jquery.min.js"></script>
  <script src="/assets/themes/foundation/javascripts/foundation.min.js"></script>
  <script src="/assets/themes/foundation/hl/highlight.pack.js"></script>
  <script src="/assets/themes/foundation/javascripts/app.js"></script>
</head>

</head>
<body>

  <!-- Nav Bar -->
  <div class="row">
    <div class="twelve columns">
      <nav class="top-bar">
      <ul>
        <!-- Title Area -->
        <li class="name">
        <h1>
          <a href="/">
            说者无意
          </a>
        </h1>
        </li>
      </ul>
      <section>
      <!-- Left Nav Section -->
      <ul class="left">
        <li class="divider"></li>
        
        
        


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">存档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  




        <li class="divider hide-for-small"></li>
      </ul>
      </section>
      </nav>
    </div>
  </div>
  <!-- End Nav -->
  <!-- Main Page Content and Sidebar -->
  <div class="row">
    <!-- Main Blog Content -->
    <div class="nine columns content" role="content">
      
<h1>Java并发同步器AQS(AbstractQueuedSynchronizer)学习笔记(1)</h1>
<article>
<p>Java中的并发包，是在Java代码中并发程序的热门话题。如果我们去读concurrent包的源码时，会发现其真正的核心是 AbstractQueuedSynchronizer ， 简称 AQS 框架 , 而 Doug Lea 大神正是此包的作者。</p>

<p>之前也看过一遍 AbstractQueuedSynchronize，但印象不深，只有依稀的印象。这次重新学习一遍，并整理出笔记，希望对自己或者是别人有用。当然了，笔者也是浅显的过一遍，很多细节也并不是完全理解。</p>

<p>建议读者先看这个系列的文章：<a href='http://whitesock.iteye.com/blog/1336920'>Inside AbstractQueuedSynchronizer</a>，之后再继续本篇。</p>

<p>首先，AQS会对进行 acquire 而被阻塞的线程进行管理，说是管理，其实就是内部维护了一个FIFO队列，这个队列是一个双向链表。链头可以理解为是一个空的节点，除了链头以外，每个节点内部都持有着一个线程，同时，有着两个重要的字段：waitStatus 和 nextWaiter。nextWaiter一般是作用与在使用Condition时的队列。而waitStatus则有以下几个字段：</p>
<ul>
<li><strong>SIGNAL</strong> 表示下一个节点应该被唤醒。为什么是下一个节点？因为刚刚说了，这个FIFO队列，链头都是一个空的节点，但此节点的 waitStatus 正好就表示了要对下一节点做的事情</li>
<li><strong>CANCELLED</strong> 表示此节点持有的线程被中断，或者该线程为null了。节点只能是暂时停留在此状态，因为在线程进入AQS时，线程会找机会整理链表，包括删除CANCELLED状态的节点。</li>
<li><strong>CONDITION</strong> 表示此节点是在另一个队列中 —— condition队列中。比如我们使用的ReentrantLock.newCondition()获得Condition对象进行await时，在AQS内部所产生的节点。</li>
<li><strong>PROPAGATE</strong> 顾名思义，传播。这点比较难理解，需要仔细推敲。因为此状态是为共享同步器使用的。加入此状态，可以避免无谓的线程 park 和 unpark。按照我对代码的理解，这是对多个线程并发获取共享同步器(比如acquireShared)所进行的优化，至少有3个线程并发，但想要优化效果明显的话，可能需要几十个线程并发的获取共享同步器(比如acquireShared)，如果在并发量非常大的时候，对系统的吞吐量的作用应该不少。</li>
</ul>
<p>AbstractQueuedSynchronizer内置一个state字段，用来表示某种意义——当ReentrantLock使用AQS的时候，state被用来表示锁被重入的次数；当&#8217;Semaphore&#8217;使用AQS的时候，state则被用来表示当前还有多少信号量可被获取。</p>

<p>AbstractQueuedSynchronizer 支持两种模式，分别是独占式和共享式。两者进行获取和释放动作的思路都是差不多的。</p>

<p>获取同步器的流程如下：</p>
<div>
  <pre><code class='java'>if(尝试获取成功){
  return;
}else{
  加入等待队列;
  park自己;
}</code></pre>
</div>
<p>释放同步器的流程如下：</p>
<div>
  <pre><code class='java'>if(尝试释放成功){
  unpark等待队列中第一个节点;
}else{
  return false;
}</code></pre>
</div>
<p>只要环绕着这两个思路去看AQS中的代码，相信应该可以明白其中的主要原理。</p>
</article>

<hr/>
<dl class="tabs">
  <dd class="active"><a href="#postMeta">文章信息</a></dd>
  <dd><a href="#related">相关文章</a></dd>
  <dd class="hide-for-small"><a href="#otherRead">别人也读过</a></dd>
</dl>
<ul class="tabs-content">

  <li class="active" id="postMetaTab">
    <dl class="sub-nav">
      
      <dt>分类:</dt>
      
      <dd><a href="/categories.html#java-ref">java</a></dd>
      
      <dd><a href="/categories.html#concurrent-ref">concurrent</a></dd>
      
      
    
      
      <dt>标签:</dt>
        
        <dd><a href="/tags.html#AbstractQueuedSynchronizer-ref">AbstractQueuedSynchronizer</a></dd>
        
        <dd><a href="/tags.html#aqs-ref">aqs</a></dd>
        
        <dd><a href="/tags.html#concurrent-ref">concurrent</a></dd>
        
        <dd><a href="/tags.html#Java-ref">Java</a></dd>
        
        <dd><a href="/tags.html#并发-ref">并发</a></dd>
        
        
    </dl>
  </li>

  <li id="relatedTab">
  
    <ul class="circle">
    
    <li><a href="/2012/10/12/aqs_2">Java并发同步器AQS(AbstractQueuedSynchronizer)学习笔记(2)</a></li>
    
    <li><a href="/2012/10/09/terminator_in_ubuntu_bugfix">terminator在ubuntu下有僵尸进程的解决</a></li>
    
    <li><a href="/2011/11/17/tokyo-tyrant-vs-redis">Tokyo Tyrant 与 Redis 的一些简单比较</a></li>
    
    <li><a href="/2011/07/30/unix-io-model">关于IO的同步,异步,阻塞,非阻塞</a></li>
    
    <li><a href="/2012/07/31/resolved_ubuntu_hosts">解决 ubuntu 的 /etc/hosts 重启就被还原</a></li>
    
    <li><a href="/2011/10/22/virtual-memory">内存学习——虚拟内存</a></li>
    
    <li><a href="/2011/10/16/why_virtual_memory">内存学习——为什么需要虚拟内存</a></li>
    
    <li><a href="/2012/05/05/using_terminator">terminator的高效使用</a></li>
    
    </ul>
  
  </li>

  <li id="otherReadTab">
  
    <ul class="circle">
    
    <li><a href="/2012/07/31/resolved_ubuntu_hosts">解决 ubuntu 的 /etc/hosts 重启就被还原</a></li>
    
    <li><a href="/2011/07/30/unix-io-model">关于IO的同步,异步,阻塞,非阻塞</a></li>
    
    <li><a href="/2012/05/05/using_terminator">terminator的高效使用</a></li>
    
    <li><a href="/2012/10/12/aqs_2">Java并发同步器AQS(AbstractQueuedSynchronizer)学习笔记(2)</a></li>
    
    <li><a href="/2011/11/17/tokyo-tyrant-vs-redis">Tokyo Tyrant 与 Redis 的一些简单比较</a></li>
    
    <li><a href="/2011/10/22/virtual-memory">内存学习——虚拟内存</a></li>
    
    <li><a href="/2011/10/16/why_virtual_memory">内存学习——为什么需要虚拟内存</a></li>
    
    <li><a href="/2012/10/09/terminator_in_ubuntu_bugfix">terminator在ubuntu下有僵尸进程的解决</a></li>
    
    </ul>
  
  
  </li>
</ul>

<hr/>



  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'zavakid'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="three columns">
      <div class="panel">
        <h5>关于Zava</h5>
        <p>程序员, 杭州, Linux, Java, Ruby, Bash, 爱折腾，喜欢开源, 踢业余足球, 听点收音机</p>
        <p>Follow me with:
          <a href="https://github.com/zavakid">github</a>
          <br/>more about me:
          <a href="http://about.me/zavakid"> read more</a>
        </p>
      </div>
    </aside>
    <!-- End Sidebar -->
  </div>

  <!-- End Main Content and Sidebar -->


  <!-- Footer -->

  <footer class="row">
    <div class="twelve columns">
      <hr />
      <div class="row">
        <div class="eight columns">
          <p>Site content © 2012 Zava. Powered by jekyll and jekyllbootstra, customed by Zava</p>
        </div>
        <div class="four columns">
          <ul class="inline-list right">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/sitemap.txt">网站地图</a></li>
      	
      
    
  
    
      
    
  




          </ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- End Footer -->
  

</body>
</html>

